generator client {
    provider = "prisma-client"
    output   = "../generated/prisma"
}

datasource db {
    provider = "postgresql"
}

enum UserRole {
    USER
    ADMIN
    COACH
}

enum PlanTier {
    FREE
    PRO
    TEAM
}

enum PracticeSessionStatus {
    STARTED
    UPLOADED
    TRANSCRIBING
    ANALYZING
    COMPLETED
    FAILED
}

enum PaymentStatus {
    ACTIVE
    PAST_DUE
    CANCELED
}

model User {
    id            String    @id
    name          String
    email         String
    emailVerified Boolean   @default(false)
    image         String?
    createdAt     DateTime  @default(now())
    updatedAt     DateTime  @updatedAt
    role          UserRole  @default(USER)

    sessions      Session[]
    practiceSessions PracticeSession[]
    accounts      Account[]
    planTier         PlanTier @default(FREE)
    paymentStatus    PaymentStatus @default(ACTIVE)
    usage           Usage?

    stripeCustomerId String?  @unique
    stripeSubId      String?  @unique
    memberships      TeamMember[]
    @@unique([email])
    @@map("user")
}

model Session {
    id        String   @id
    expiresAt DateTime
    token     String
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
    ipAddress String?
    userAgent String?
    userId    String
    user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([token])
    @@index([userId])
    @@map("session")
}

model Account {
    id                    String    @id
    accountId             String
    providerId            String
    userId                String
    user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
    accessToken           String?
    refreshToken          String?
    idToken               String?
    accessTokenExpiresAt  DateTime?
    refreshTokenExpiresAt DateTime?
    scope                 String?
    password              String?
    createdAt             DateTime  @default(now())
    updatedAt             DateTime  @updatedAt

    @@index([userId])
    @@map("account")
}

model Verification {
    id         String   @id
    identifier String
    value      String
    expiresAt  DateTime
    createdAt  DateTime @default(now())
    updatedAt  DateTime @updatedAt

    @@index([identifier])
    @@map("verification")
}


model Usage {
  id               String @id @default(cuid())
  userId           String @unique
  user             User   @relation(fields: [userId], references: [id])

  minutesUsed      Int    @default(0)
  sessionsUsed     Int    @default(0)

  resetAt          DateTime

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model PracticeSession {
  id               String   @id @default(cuid())
  userId           String
  user             User     @relation(fields: [userId], references: [id])

  status           PracticeSessionStatus @default(UPLOADED)

  audioUrl         String?
  durationSeconds  Int?

  transcript       String?
  transcriptLang   String?

  wordsPerMinute   Int?
  fillerCount      Int?
  pauseCount       Int?

  clarityScore     Float?
  confidenceScore  Float?

  feedbackJson     Json?
  aiModel          String?
  aiCostCents      Int?

  errorMessage     String?

  createdAt        DateTime @default(now())
  completedAt      DateTime?

  analyses         Analysis[]

  @@index([userId, createdAt])
}

model Analysis {
  id               String   @id @default(cuid())
  practiceSessionId        String
  practiceSession          PracticeSession  @relation(fields: [practiceSessionId], references: [id])

  promptVersion    String
  modelUsed        String

  inputTokens      Int
  outputTokens     Int
  costCents        Int

  result           Json
  success          Boolean  @default(true)
  errorMessage     String?

  createdAt        DateTime @default(now())

  @@index([practiceSessionId])
  
}

model Team {
  id               String @id @default(cuid())
  name             String

  stripeCustomerId String?
  stripeSubId      String?

  members          TeamMember[]

  createdAt        DateTime @default(now())
}

model TeamMember {
  id        String @id @default(cuid())
  teamId   String
  userId   String
  role     UserRole @default(USER)

  team     Team @relation(fields: [teamId], references: [id])
  user     User @relation(fields: [userId], references: [id])

  @@unique([teamId, userId])
}

model WebhookEvent {
  id            String   @id
  provider      String
  processed     Boolean  @default(false)
  payload       Json
  receivedAt    DateTime @default(now())
}